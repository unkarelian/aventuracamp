---
interface Props {
  compact?: boolean;
}

const { compact = false } = Astro.props;

// Fetch latest release from GitHub
let version = '0.3.8'; // fallback
let assets: { name: string; browser_download_url: string }[] = [];

try {
  const response = await fetch('https://api.github.com/repos/unkarelian/Aventura/releases/latest');
  if (response.ok) {
    const data = await response.json();
    version = data.tag_name?.replace(/^v/, '') || version;
    assets = data.assets || [];
  }
} catch (e) {
  // Use fallback version
}

const findAsset = (pattern: RegExp) =>
  assets.find(a => pattern.test(a.name))?.browser_download_url;

const baseUrl = `https://github.com/unkarelian/Aventura/releases/download/v${version}`;

const downloads = [
  {
    platform: 'Windows',
    icon: 'desktop_windows',
    href: findAsset(/\.exe$/) || `${baseUrl}/Aventura_${version}_x64-setup.exe`,
    primary: true,
  },
  {
    platform: 'macOS',
    icon: 'laptop_mac',
    href: findAsset(/\.dmg$/) || `${baseUrl}/Aventura_${version}_x64.dmg`,
    primary: false,
  },
  {
    platform: 'Linux',
    icon: 'terminal',
    href: findAsset(/\.AppImage$/) || `${baseUrl}/Aventura_${version}_amd64.AppImage`,
    primary: false,
  },
  {
    platform: 'Android',
    icon: 'android',
    href: findAsset(/\.apk$/) || `${baseUrl}/aventura-release.apk`,
    primary: false,
  },
];
---

<div class:list={['flex flex-wrap gap-4', compact ? '' : 'w-full']}>
  {downloads.map(download => (
    <a
      href={download.href}
      class:list={[
        'flex items-center justify-center gap-2 rounded-lg transition-colors font-bold font-body',
        compact ? 'h-10 px-4 text-sm' : 'flex-1 sm:flex-none min-w-[140px] h-12 px-6 text-base',
        download.primary
          ? 'bg-primary hover:bg-orange-600 text-background-dark shadow-lg shadow-primary/20'
          : 'bg-surface-dark border border-border-brown hover:border-primary/50 text-text-cream'
      ]}
    >
      <span class:list={['material-symbols-outlined', compact ? 'text-[18px]' : 'text-[20px]']}>{download.icon}</span>
      <span>{download.platform}</span>
    </a>
  ))}
</div>

{!compact && (
  <p class="text-text-muted/60 text-xs font-body mt-4">
    Open Source &bull; Free to use &bull; Local AI Supported
  </p>
)}
